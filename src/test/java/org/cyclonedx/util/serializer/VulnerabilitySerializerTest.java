/*
 * This file is part of CycloneDX Core (Java).
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.cyclonedx.util.serializer;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.cyclonedx.Version;
import org.cyclonedx.generators.BomGeneratorFactory;
import org.cyclonedx.generators.json.BomJsonGenerator;
import org.cyclonedx.generators.xml.BomXmlGenerator;
import org.cyclonedx.model.Bom;
import org.cyclonedx.model.ExternalReference;
import org.cyclonedx.model.Hash;
import org.cyclonedx.model.Tool;
import org.cyclonedx.model.vulnerability.Vulnerability;
import org.cyclonedx.parsers.JsonParser;
import org.cyclonedx.parsers.XmlParser;
import org.junit.jupiter.api.Test;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class VulnerabilitySerializerTest {

    @Test
    public void testEmptyStringsNotSerialized_json() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");
        vuln.setDescription("");  // Empty string
        vuln.setDetail("");       // Empty string
        vuln.setRecommendation(""); // Empty string
        vuln.setWorkaround("");   // Empty string

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_16, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode vulnNode = root.get("vulnerabilities").get(0);

        // ID should be present
        assertTrue(vulnNode.has("id"));
        assertEquals("CVE-2024-1234", vulnNode.get("id").asText());

        // Empty strings should not be present
        assertFalse(vulnNode.has("description"), "Empty description should not be serialized");
        assertFalse(vulnNode.has("detail"), "Empty detail should not be serialized");
        assertFalse(vulnNode.has("recommendation"), "Empty recommendation should not be serialized");
        assertFalse(vulnNode.has("workaround"), "Empty workaround should not be serialized");
    }

    @Test
    public void testEmptyStringsNotSerialized_xml() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");
        vuln.setDescription("");  // Empty string
        vuln.setDetail("");       // Empty string
        vuln.setRecommendation(""); // Empty string
        vuln.setWorkaround("");   // Empty string

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        BomXmlGenerator generator = BomGeneratorFactory.createXml(Version.VERSION_16, bom);
        String xmlString = generator.toXmlString();

        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        org.w3c.dom.Document doc = builder.parse(new ByteArrayInputStream(xmlString.getBytes(StandardCharsets.UTF_8)));

        // Empty strings should not be present in XML
        assertFalse(xmlString.contains("<description></description>"), "Empty description should not be serialized");
        assertFalse(xmlString.contains("<detail></detail>"), "Empty detail should not be serialized");
        assertFalse(xmlString.contains("<recommendation></recommendation>"), "Empty recommendation should not be serialized");
        assertFalse(xmlString.contains("<workaround></workaround>"), "Empty workaround should not be serialized");
    }

    @Test
    public void testDeprecatedToolsConvertedToComponents_v15_json() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create deprecated tools
        List<Tool> tools = new ArrayList<>();
        Tool tool = new Tool();
        tool.setVendor("OWASP");
        tool.setName("Dependency-Track");
        tool.setVersion("4.0.0");

        List<Hash> hashes = new ArrayList<>();
        Hash hash = new Hash(Hash.Algorithm.SHA_256, "abc123");
        hashes.add(hash);
        tool.setHashes(hashes);

        tools.add(tool);
        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.5 (should convert tools to components)
        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_15, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode vulnNode = root.get("vulnerabilities").get(0);

        // Tools should be present
        assertTrue(vulnNode.has("tools"), "Tools should be present");
        JsonNode toolsNode = vulnNode.get("tools");

        // Should have components (not the deprecated tool format)
        assertTrue(toolsNode.has("components"), "Should have components");
        JsonNode componentsNode = toolsNode.get("components");
        assertEquals(1, componentsNode.size());

        // Verify the conversion
        JsonNode component = componentsNode.get(0);
        assertEquals("application", component.get("type").asText());
        assertEquals("OWASP", component.get("group").asText());
        assertEquals("Dependency-Track", component.get("name").asText());
        assertEquals("4.0.0", component.get("version").asText());
        assertTrue(component.has("hashes"));
        assertEquals("SHA-256", component.get("hashes").get(0).get("alg").asText());
        assertEquals("abc123", component.get("hashes").get(0).get("content").asText());

        // Validate against schema
        JsonParser parser = new JsonParser();
        assertTrue(parser.isValid(jsonString.getBytes(StandardCharsets.UTF_8), Version.VERSION_15));
    }

    @Test
    public void testDeprecatedToolsConvertedToComponents_v16_json() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create deprecated tools
        List<Tool> tools = new ArrayList<>();
        Tool tool = new Tool();
        tool.setVendor("OWASP");
        tool.setName("Dependency-Track");
        tool.setVersion("4.0.0");
        tools.add(tool);
        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.6
        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_16, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode vulnNode = root.get("vulnerabilities").get(0);

        // Tools should be present with components
        assertTrue(vulnNode.has("tools"));
        JsonNode toolsNode = vulnNode.get("tools");
        assertTrue(toolsNode.has("components"));

        // Validate against schema
        JsonParser parser = new JsonParser();
        assertTrue(parser.isValid(jsonString.getBytes(StandardCharsets.UTF_8), Version.VERSION_16));
    }

    @Test
    public void testDeprecatedToolsConvertedToComponents_xml() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create deprecated tools
        List<Tool> tools = new ArrayList<>();
        Tool tool = new Tool();
        tool.setVendor("OWASP");
        tool.setName("Dependency-Track");
        tool.setVersion("4.0.0");
        tools.add(tool);
        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.5 (should convert tools to components)
        BomXmlGenerator generator = BomGeneratorFactory.createXml(Version.VERSION_15, bom);
        String xmlString = generator.toXmlString();

        // Parse the XML to verify structure
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setNamespaceAware(true);
        DocumentBuilder builder = factory.newDocumentBuilder();
        org.w3c.dom.Document doc = builder.parse(new ByteArrayInputStream(xmlString.getBytes(StandardCharsets.UTF_8)));

        // Verify tools/components structure exists
        assertTrue(xmlString.contains("<tools>"));
        assertTrue(xmlString.contains("<component"));
        assertTrue(xmlString.contains("<name>Dependency-Track</name>"));
        assertTrue(xmlString.contains("<group>OWASP</group>"));
        assertTrue(xmlString.contains("<version>4.0.0</version>"));

        // Validate against schema
        XmlParser parser = new XmlParser();
        assertTrue(parser.isValid(xmlString.getBytes(StandardCharsets.UTF_8), Version.VERSION_15));
    }

    @Test
    public void testDeprecatedToolsNotConvertedForV14_json() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create deprecated tools
        List<Tool> tools = new ArrayList<>();
        Tool tool = new Tool();
        tool.setVendor("OWASP");
        tool.setName("Dependency-Track");
        tool.setVersion("4.0.0");
        tools.add(tool);
        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.4 (should NOT convert, keep deprecated format)
        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_14, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode vulnNode = root.get("vulnerabilities").get(0);

        // Tools should be present in old array format
        assertTrue(vulnNode.has("tools"));
        JsonNode toolsNode = vulnNode.get("tools");
        assertTrue(toolsNode.isArray(), "For v1.4, tools should be an array");
        assertEquals(1, toolsNode.size());

        // Should NOT have components structure
        JsonNode toolNode = toolsNode.get(0);
        assertTrue(toolNode.has("vendor"));
        assertTrue(toolNode.has("name"));
        assertTrue(toolNode.has("version"));

        // Validate against schema
        JsonParser parser = new JsonParser();
        assertTrue(parser.isValid(jsonString.getBytes(StandardCharsets.UTF_8), Version.VERSION_14));
    }

    @Test
    public void testToolsWithExternalReferences_converted() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create tool with external references
        List<Tool> tools = new ArrayList<>();
        Tool tool = new Tool();
        tool.setVendor("OWASP");
        tool.setName("Dependency-Track");
        tool.setVersion("4.0.0");

        List<ExternalReference> refs = new ArrayList<>();
        ExternalReference ref = new ExternalReference();
        ref.setType(ExternalReference.Type.WEBSITE);
        ref.setUrl("https://example.com");
        refs.add(ref);
        tool.setExternalReferences(refs);

        tools.add(tool);
        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.5
        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_15, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode vulnNode = root.get("vulnerabilities").get(0);
        JsonNode component = vulnNode.get("tools").get("components").get(0);

        // External references should be preserved
        assertTrue(component.has("externalReferences"));
        assertEquals(1, component.get("externalReferences").size());
        assertEquals("website", component.get("externalReferences").get(0).get("type").asText());
        assertEquals("https://example.com", component.get("externalReferences").get(0).get("url").asText());

        // Validate against schema
        JsonParser parser = new JsonParser();
        assertTrue(parser.isValid(jsonString.getBytes(StandardCharsets.UTF_8), Version.VERSION_15));
    }

    @Test
    public void testMultipleDeprecatedToolsConverted() throws Exception {
        Vulnerability vuln = new Vulnerability();
        vuln.setId("CVE-2024-1234");

        // Create multiple deprecated tools
        List<Tool> tools = new ArrayList<>();

        Tool tool1 = new Tool();
        tool1.setVendor("OWASP");
        tool1.setName("Dependency-Track");
        tool1.setVersion("4.0.0");
        tools.add(tool1);

        Tool tool2 = new Tool();
        tool2.setVendor("CycloneDX");
        tool2.setName("CLI");
        tool2.setVersion("1.0.0");
        tools.add(tool2);

        vuln.setTools(tools);

        Bom bom = new Bom();
        bom.setVulnerabilities(Collections.singletonList(vuln));

        // Generate for version 1.5
        BomJsonGenerator generator = BomGeneratorFactory.createJson(Version.VERSION_15, bom);
        String jsonString = generator.toJsonString();

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(jsonString);
        JsonNode componentsNode = root.get("vulnerabilities").get(0).get("tools").get("components");

        // Both tools should be converted
        assertEquals(2, componentsNode.size());

        JsonNode comp1 = componentsNode.get(0);
        assertEquals("OWASP", comp1.get("group").asText());
        assertEquals("Dependency-Track", comp1.get("name").asText());

        JsonNode comp2 = componentsNode.get(1);
        assertEquals("CycloneDX", comp2.get("group").asText());
        assertEquals("CLI", comp2.get("name").asText());

        // Validate against schema
        JsonParser parser = new JsonParser();
        assertTrue(parser.isValid(jsonString.getBytes(StandardCharsets.UTF_8), Version.VERSION_15));
    }
}